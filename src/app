#!/usr/bin/python3
# -*- coding: utf-8 -*-

# built ins
import asyncio
from asyncio import Queue
import os
import signal
import sys

# installed
import tomli
import uvloop
from loguru import logger as log
import numpy as np
import orjson
import redis.asyncio as aioredis
#from redistimeseries.client import Client

asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())

from data_cleaning.app_data_cleaning import reconciling_size
from messaging.telegram_bot import telegram_bot_sendtext
#from strategies.app_future_spreads import future_spreads
#from strategies.app_hedging_spot import hedging_spot
from strategies.relabelling_trading_result import relabelling_trades
from streaming_data.data_producer import StreamingAccountData
from transaction_management.deribit.api_requests import SendApiRequest
from transaction_management.deribit.avoiding_double_ids import \
    avoiding_double_ids
from market_understanding.price_action.candles_analysis import get_market_condition
from transaction_management.deribit.allocating_ohlc import updating_ohlc
from transaction_management.deribit.cancelling_active_orders import \
    cancelling_orders
from transaction_management.deribit.capturing_user_changes import \
    saving_and_relabelling_orders
from transaction_management.deribit.distributing_ws_data import caching_distributing_data
from transaction_management.deribit.managing_deribit import ModifyOrderDb
from transaction_management.deribit.processing_orders import \
    processing_orders
from transaction_management.deribit.updating_ticker import \
    update_cached_ticker
from utilities.system_tools import (
    SignalHandler,
    parse_error_message, 
    provide_path_for_file,
    )
from db_management.redis_client import RedisClient


def handle_ctrl_c(
    signum, 
    stack_frame
    )->None:
    
    sys.exit(0)
    
                  
signal_handler = SignalHandler()


def get_config(file_name: str) -> list:
    """ """
    
    config_path = provide_path_for_file (file_name)
    
    try:
        if os.path.exists(config_path):
            with open(config_path, "rb") as handle:
                read= tomli.load(handle)
                return read
    except Exception as error:
        parse_error_message(error)
        return []

async def main():
    """
    https://redis-py.readthedocs.io/en/stable/examples/asyncio_examples.html
    """
    sub_account_id = "deribit-148510"

    # registering strategy config file    
    file_toml = "config_strategies.toml"
    
    idle_time = 2

    try:

        private_data: object = SendApiRequest(sub_account_id)

        modify_order_and_db: object = ModifyOrderDb(sub_account_id)
        
        pool = aioredis.ConnectionPool.from_url(
            "redis://localhost", 
            port=6379, 
            db=0, 
            protocol=3, 
            decode_responses=True
            )
        
        client_redis = aioredis.Redis.from_pool(pool)
                
        # parsing config file
        config_app = get_config(file_toml)

        # get tradable strategies
        tradable_config_app = config_app["tradable"]

        # get TRADABLE currencies
        currencies: list = [o["spot"] for o in tradable_config_app][0]

        # get redis channels
        redis_channels: dict = config_app["redis_channels"][0]

        resolutions: list = config_app["resolutions"]["resolutions"] 

        strategy_attributes = config_app["strategies"]

        queue = Queue(maxsize=1)
        
        stream = StreamingAccountData(sub_account_id)
                
        producer_task = asyncio.create_task(
            stream.ws_manager(
                queue,
                currencies,
                resolutions,
                strategy_attributes)
            ) 
        
        saving_task = asyncio.create_task(
            caching_distributing_data(
                private_data,
                modify_order_and_db,
                client_redis,
                config_app,
                queue,
                )
            ) 
        
        await asyncio.sleep(0.0005)
        
        """


            processing_orders(
                modify_order_and_db,
                client_redis,
                config_app,
                ),
                        
            cancelling_orders(
                private_data,
                modify_order_and_db,
                client_redis,
                config_app
                ),    
       
            saving_and_relabelling_orders(
                private_data,
                modify_order_and_db,
                client_redis,
                config_app,),
    
      
            avoiding_double_ids(
                modify_order_and_db,
                client_redis,
                config_app,
                ),
       
            relabelling_trades(
                modify_order_and_db,
                config_app),
            
            update_cached_ticker(
                client_redis,
                config_app),
            
            get_market_condition(
                client_redis,
                config_app,
                np),
            
            
            hedging_spot(
                private_data,
                client_redis,
                config_app,),

            reconciling_size(
                modify_order_and_db,
                config_app,
                idle_time),                
            #scanning_volume()
                  
            """
            
        await asyncio.gather(
            producer_task, 
        
            saving_task,
                    
            #future_spreads(
            #    private_data,
            #    client_redis,
            #    config_app,
            #    ),

            updating_ohlc(
                client_redis,
                currencies,
                resolutions,
                redis_channels,),
            
                        )  

        await queue.join()

    except Exception as error:
        
        parse_error_message(error)
        await telegram_bot_sendtext (
            f"app-{error}",
            "general_error"
            )

if __name__ == "__main__":
    
    try:
        signal.signal(signal.SIGINT, handle_ctrl_c) # terminate on ctrl-c
        
        uvloop.run(main())
        
    except(
        KeyboardInterrupt, 
        SystemExit
        ):
        
        asyncio.get_event_loop().run_until_complete(main())
        
    except Exception as error:
        parse_error_message(error)
        
        asyncio.run(telegram_bot_sendtext (
            error,
            "general_error"
            ))
